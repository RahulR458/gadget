<%- include('../includes/header.ejs') %>

<div class="wrap-header-cart js-panel-cart">
    <div class="s-full js-hide-cart"></div>

    <div class="header-cart flex-col-l p-l-65 p-r-25">
        <div class="header-cart-title flex-w flex-sb-m p-b-8">
            <span class="mtext-103 cl2">
                Your Cart
            </span>

            <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                <i class="zmdi zmdi-close"></i>
            </div>
        </div>
        
        <div class="header-cart-content flex-w js-pscroll">
            <ul class="header-cart-wrapitem w-full">
                <li class="header-cart-item flex-w flex-t m-b-12">
                    <div class="header-cart-item-img">
                        <img src="images/item-cart-01.jpg" alt="IMG">
                    </div>

                    <div class="header-cart-item-txt p-t-8">
                        <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                            White Shirt Pleat
                        </a>

                        <span class="header-cart-item-info">
                            1 x $19.00
                        </span>
                    </div>
                </li>

                <li class="header-cart-item flex-w flex-t m-b-12">
                    <div class="header-cart-item-img">
                        <img src="images/item-cart-02.jpg" alt="IMG">
                    </div>

                    <div class="header-cart-item-txt p-t-8">
                        <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                            Converse All Star
                        </a>

                        <span class="header-cart-item-info">
                            1 x $39.00
                        </span>
                    </div>
                </li>

                <li class="header-cart-item flex-w flex-t m-b-12">
                    <div class="header-cart-item-img">
                        <img src="images/item-cart-03.jpg" alt="IMG">
                    </div>

                    <div class="header-cart-item-txt p-t-8">
                        <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                            Nixon Porter Leather
                        </a>

                        <span class="header-cart-item-info">
                            1 x $17.00
                        </span>
                    </div>
                </li>
            </ul>
            
            <div class="w-full">
                <div class="header-cart-total w-full p-tb-40">
                    Total: $75.00
                </div>

                <div class="header-cart-buttons flex-w w-full">
                    <a href="shoping-cart.html" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
                        View Cart
                    </a>

                    <a href="shoping-cart.html" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-10">
                        Check Out
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- breadcrumb -->
<div class="container">
    <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
        <a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">
            Home
            <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>

        <span class="stext-109 cl4">
            Checkout
        </span>
    </div>
</div>
    

<!-- Shoping Cart -->
<!-- <form class="bg0 p-t-75 p-b-85"> -->
    <div class="container">
        <div class="row">
            <div class="col-lg-7 col-md-7 col-xl-7 ">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <div class="wrap-table-shopping-cart">
                        <table class="table-shopping-cart">
                            <tr class="table_head">
                                <th class="column-1">Product</th>
                                <th class="column-2">Product Name</th>
                                <th class="column-3">Price</th>
                                <th class="column-4">Quantity</th>
                                <th class="column-6">Total</th>
                            </tr>

                            <% for(var i=0;i<products.length; i++){%>
                            <tr class="table_row">
                                <td class="column-1">
                                    <div class="how-itemcart1">
                                        <img src="/user/images/<%= products[i].image %>" alt="IMG">
                                    </div>
                                </td>
                                <td class="column-2"><%= products[i].productName %></td>
                                <td class="column-3"><%= products[i].price %></td>
                                <td class="column-5">  
                                    
                                        <% for(var k=0;k<user.cart.item.length;k++){%>
                                            <% if( products[i]._id.toString()==user.cart.item[k].productId.toString() ) { %>
                                               
                                                <span ><%= user.cart.item[k].qty %></span>
                                                <!-- <input class="mtext-104 cl3 txt-center num-product" type="number" name="num-product1" value="<%= user.cart.item[k].qty %>"> -->
                                    
                                                
                                                <% } %>
                                                    <%}%>
                                  
                   
                                </td>
                            
                                <td class="column-6">
                                    <% for(var j=0;j<user.cart.item.length;j++){%>
                                        <% if(products[i]._id.toString() == user.cart.item[j].productId.toString()){%>
                                            <span><%= user.cart.item[j].singletotal %></span>
                                        <% } %>
                                    <% } %>
                                </td>
                                
                            </tr>
                            <% } %>

                          
                        </table>
                    </div>
                    <!-- <form action="/couponPost" method="post"> -->
                    <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                        <div class="flex-w flex-m m-r-20 m-tb-5">
                            <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" name="coupon" id="coupon" placeholder="Coupon Code">
                                
                            <div class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5" onclick="couponPost()">
                                Apply coupon
                            </div>
                        </div>
                    </div>
                    <!-- </form> -->
                    <br>
                    <div class="wrap-table-shopping-cart">
                    <table class="table-shopping-cart">
                        <tr class="table_head">
                            <th class="column-1">Coupon Name</th>
                            <th class="column-2">Coupon code</th>
                            <th class="column-3">Coupon Percentage</th>
                        </tr>

                        <% for(var i=0;i<coupon.length; i++){%>
                        <tr class="table_row">
                           
                            <td class="column-1"><%= coupon[i].name %></td>
                            <td class="column-2"><%= coupon[i].code %></td>
                            <td class="column-3"><%= coupon[i].percent + "%" %></td>
                            
                    
                            </td>
                        
                           
                            
                        </tr>
                        <% } %>

                      
                    </table>
                    </div>
                    

                    <!-- <div class="flex-w flex-t bor12 p-b-13" style="display: flex;">
                        
                        <div style="flex: 1;"></div>
                        <br>
                        <div class="size-208" style="flex: 8;">
                            <span class="stext-110 cl2" style="font-weight: lighter;">
                                Subtotal:
                            </span>
                        </div>

                        <div class="size-209" style="flex: 2;">
                            <span class="mtext-110 cl2" style="font-weight: lighter;">
                                <%= total %>
                            </span>
                        </div>
                    </div>

                    <div class="flex-w flex-t bor12 p-b-13" style="display: flex;">
                        
                        <div style="flex: 1;"></div>
                        <br>
                        <div class="size-208" style="flex: 8;">
                            <span class="stext-110 cl2" style="font-size: small;">
                                Shippping
                            </span>
                        </div>

                        <div class="size-209" style="flex: 2;">
                            <span class="mtext-110 cl2" style="font-size: small;">
                                free Shippping
                            </span>
                        </div>
                    </div>

                    <div class="flex-w flex-t bor12 p-b-13" style="display: flex;">
                        
                        <div style="flex: 1;"></div>
                        <br>
                        <div class="size-208" style="flex: 8;">
                            <span class="stext-110 cl2" style="font-weight: bold;">
                                Total:
                            </span>
                        </div>

                        <div class="size-209" style="flex: 2;">
                            <span class="mtext-110 cl2" style="font-weight: bold;">
                                <%= total %>
                            </span>
                        </div>
                    </div> -->


                    <!-- <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                        <div class="flex-w flex-m m-r-20 m-tb-5">
                            <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" name="coupon" placeholder="Coupon Code">
                                
                            <div class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                                Apply coupon
                            </div>
                        </div>

                        <div class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                            Update Cart
                        </div>
                    </div> -->
                    
                </div>
                
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <br>
                  <h2 class="h3 mb-3 text-black">Billing Details</h2>
                  <div class="p-3 p-lg-5 border">
                    <form action="/myAcountAddress" method="post">
                        <div class="row">
                            <div class="col-sm-6">
                                <label>Full Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div><!-- End .col-sm-6 -->

                            <div class="col-sm-6">
                                <label>Phone Number *</label>
                                <input type="text" class="form-control" name="number" required>
                            </div><!-- End .col-sm-6 -->
                        </div><!-- End .row -->

                        <label>Pincode *</label>
                        <input type="text" class="form-control" name="pincode" required>
                        <!-- <small class="form-text">This will be how your name will be displayed in the account section and in reviews</small> -->

                        <!-- <label>Email address *</label>
                        <input type="email" class="form-control" required> -->

                        <label>State</label>
                        <input type="text" class="form-control" name="state" required>

                        <label>City</label>
                        <input type="text" class="form-control" name="city" required>

                        <label>House No</label>
                        <input type="text" class="form-control mb-2" name="house" required>

                        <label>Road Name</label>
                        <input type="text" class="form-control mb-2" name="road" required>

                        <button type="submit" class="btn btn-outline-primary-2" style="background-color: rgb(0, 0, 0); color: aliceblue;">
                            <span >Add Address</span>
                            <i class="icon-long-arrow-right"></i>
                        </button>
                    </form>
                        </div>
      
                      <!-- </div> -->
                    </div>
      
                    
                    
                </div>
  
            
            
            <div class="col-lg-5 col-md-5 col-xl-5 ">
                <br>
                <form onsubmit=" odderPost();return false">
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                    <h4 class="mtext-109 cl2 p-b-30">
                        Cart Totals
                    </h4>

                    <div class="flex-w flex-t bor12 p-b-13">
                        <div class="size-208">
                            <span class="stext-110 cl2">
                                Subtotal:
                            </span>
                        </div>

                        <div class="size-209">
                            <span class="mtext-110 cl2">
                                <%= total %>
                            </span>
                        </div>
                    </div>

                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl2">
                                Shipping:
                            </span>
                        </div>

                        <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                            <p class="stext-111 cl6 p-t-2">
                                Free Shipping
                            </p>

                            
                            
                            <!-- <div class="p-t-15">
                                <span class="stext-112 cl8">
                                    Calculate Shipping
                                </span>

                                <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-12 m-t-9">
                                    <select class="js-select2" name="time">
                                        <option>Select a country...</option>
                                        <option>USA</option>
                                        <option>UK</option>
                                    </select>
                                    <div class="dropDownSelect2"></div>
                                </div>

                                <div class="bor8 bg0 m-b-12">
                                    <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="state" placeholder="State /  country">
                                </div>

                                <div class="bor8 bg0 m-b-22">
                                    <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="postcode" placeholder="Postcode / Zip">
                                </div> -->
                                
                                <!-- <div class="flex-w">
                                    <div class="flex-c-m stext-101 cl2 size-115 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer">
                                        Update Totals
                                    </div>
                                </div> -->
                                    
                            <!-- </div> -->
                            
                        </div>
                        
                    </div>
                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl2">
                                Payment:
                            </span>
                        </div>
                        <!-- <input type="radio" id="html" name="fav_language" value="HTML">
                        <label for="html">Cash On Delivery</label><br>
                        <input type="radio" id="html" name="fav_language" value="HTML">
                        <label for="html">Razorpay</labe<input type="radio" id="html" name="fav_language" value="HTML"> -->
                            <div>
                                <div style="display: flex; ">
                                    <input type="radio" id="cod" name="paymentdt" value="cod" onclick="payments('Cash On Delivery')">
                                    <label for="cod" style="margin-top: 8px; margin-left: 4px;">Cash On Delivery</label>
                                </div>
                                <div style="display: flex; ">
                                    <input type="radio" id="razorpay" name="paymentdt" value="razorpay" onclick="payments('razorpay')">&nbsp;
                                    <label for="razorpay" style="margin-top: 8px;">Razorpay</label>
                                </div>
                                
                            </div>
                            
                            
                    </div>

                    <div class="flex-w flex-t p-t-27 p-b-33">
                        <div class="size-208">
                            <span class="mtext-101 cl2">
                                Total:
                            </span>
                        </div>

                        <div class="size-209 p-t-1">
                            <span class="mtext-110 cl2">
                                <%= user.cart.totalPrice %>
                            </span>
                        </div>
                    </div>

                    <a href="/orderSucces">
                        <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                            Place Order
                        </button>
                    </a>
                   
                </div>
                <br>
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                                                
                    <% for(var i=0;i<userAddress.length;i++){%>
                    <div class="card card-dashboard">
                        <div class="card-body">
                            <h3 class="card-title">Billing Address</h3><!-- End .card-title -->
                            
                            <p><%= userAddress[i].fullname %><br>
                                <%= userAddress[i].phone1 %><br>
                                <%= userAddress[i].pincode %><br>
                                <%= userAddress[i].state %><br>
                                <%= userAddress[i].city %><br>
                                <%= userAddress[i].houseNo %><br>
                                <%= userAddress[i].roadName %><br>
                                
                            <a href="#">Edit <i class="icon-edit"></i></a></p>
                            
                            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <input type="radio" id="selectAddress" name="address" onclick="address1('<%= userAddress[i]._id%>')" value="<%= userAddress[i].id %>">   
                                <label for="selectAddress">Select Address</label>
                            </div>
                           
                        </div><!-- End .card-body -->
                    </div><!-- End .card-dashboard -->
                    <br>
                   
                    <%}%>
                </div>
                <br>
                </form>
            </div>
            
            
        </div>
            
           
            <!-- <div class="row"> -->
                
                
                
                
            <!-- </div> -->

            
        </div>
    </div>
<!-- </form> -->
<script> 
let addressval ;
    let paymentval ;

	function address1(value){
		addressval=value
		console.log(addressval+"addressval")
	}

	function payments(value){
		paymentval=value
		console.log(paymentval+"payment")
	}

    function couponPost(){
        let coupon = document.getElementById("coupon").value;
        console.log("coupon");
        console.log(coupon);
        fetch("/couponPost", {
            method: "put",
            headers: {
                "Content-Type": "application/json",
                // Add any other headers here if needed
            },
            body: JSON.stringify({ values: coupon })

        })
                    .then(response => {
						const result = response.json()
						return result
					})
					.then(data => {
						console.log('Success:', data)
                        window.location.reload();
                        

					})
    }

    function odderPost(){

console.log(addressval)
console.log(paymentval)

fetch("/order/succesPost/check", {
method: "post",
headers: {
    "Content-Type": "application/json",
    // Add any other headers here if needed
},
body: JSON.stringify({}),
})
.then((response) => {
    return response.json();

})
.then((data) => {
    console.log(data);
    if(data?.abc == "not"){
        console.log("checkoutPost");
        fetch("/checkoutPost", {
method: "post",
headers: {
    "Content-Type": "application/json",
    // Add any other headers here if needed
},
body: JSON.stringify({addresid:addressval,payment:paymentval}),
})
.then((response) => {
    return response.json();

})
.then((data) => {
    console.log(data);
    if(data?.payment == "Cash On Delivery"){
        window.location.href = '/orderSucces'
    }else{
        console.log('razopay order successful');
        rpcall(data)
    }
    // if(data==quentityLess){
    // 	quentityLess()
    // }

    // rpcall(data)
    // Example usage:
    // showToast('odder successfull!');
})
.catch((err) => console.log(err));
    }else{
        console.log("Product Not Available");
    }
    
})
.catch((err) => console.log(err));


}


    function rpcall(data){
					var options = {
    "key": "rzp_test_tNufqM4t9646Br", // Enter the Key ID generated from the Dashboard
    "amount": "50000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Acme Corp",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": data.id, //This is a sample Order ID. Pass the id obtained in the response of Step 1
    "handler": function (response){
        alert(response.razorpay_payment_id);
        alert(response.razorpay_order_id);
        alert(response.razorpay_signature)
    },
    "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9000090000"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};

var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
        alert(response.error.code);
        alert(response.error.description);
        alert(response.error.source);
        alert(response.error.step);
        alert(response.error.reason);
        alert(response.error.metadata.order_id);
        alert(response.error.metadata.payment_id);
});
rzp1.open();
				}

                
</script>

<%- include('../includes/footer.ejs') %>